#!/bin/zsh

# zellij-workspace - Open a new zellij tab with workspace layout in specified directory
# Usage: zellij-workspace [--layout regular|compact] [working_directory]
# Options:
#   --layout regular|compact  Choose workspace layout (default: compact)
# Examples:
#   zellij-workspace                    # Use compact layout in current directory
#   zellij-workspace --layout regular   # Use regular layout in current directory
#   zellij-workspace /path/to/project   # Use compact layout in specified directory
#   zellij-workspace --layout regular /path/to/project  # Use regular layout in specified directory

set -euo pipefail

# Source shared functions
ZJ_SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "${ZJ_SCRIPT_DIR}/zellij-common.zsh"

# Function to show help
show_help() {
    echo "Usage: zellij-workspace [--layout regular|compact] [working_directory]"
    echo ""
    echo "Options:"
    echo "  --layout regular|compact  Choose workspace layout (default: compact)"
    echo "  --help, -h                Show this help message"
    echo ""
    echo "Examples:"
    echo "  zellij-workspace                       # Open current directory with compact layout"
    echo "  zellij-workspace --layout regular      # Open current directory with regular layout"
    echo "  zellij-workspace /path/to/project      # Open specific directory with compact layout"
    echo "  zellij-workspace --layout regular /path/to/project  # Open specific directory with regular layout"
}

# Check for help option early
for arg in "$@"; do
    if [[ "$arg" == "--help" ]] || [[ "$arg" == "-h" ]]; then
        show_help
        exit 0
    fi
done

# Check if zellij is installed
check_zellij_installed || exit 1

# Check if we're inside a zellij session
if [[ -z "${ZELLIJ:-}" ]]; then
    exit 0
fi

# Function to open new tab with layout
open_tab_with_layout() {
    local working_dir="$1"
    local layout_path="$2"
    local tab_name

    if [[ -z "${layout_path}" ]] || [[ ! -f "${layout_path}" ]]; then
        echo "Error: No workspace layout found in ${ZJ_LAYOUT_DIR}"
        echo "Expected one of: regular-workspace-layout.kdl, compact-workspace-layout.kdl"
        exit 1
    fi

    # Determine the directory to use for tab naming
    if [[ -n "${working_dir}" ]] && [[ -d "${working_dir}" ]]; then
        tab_name=$(basename "${working_dir}")
    else
        tab_name=$(basename "${PWD}")
    fi

    # Change to the specified working directory if provided and valid
    if [[ -n "${working_dir}" ]] && [[ -d "${working_dir}" ]]; then
        echo "Opening new tab '${tab_name}' in directory: ${working_dir}"
        zellij action new-tab --layout "${layout_path}" --cwd "${working_dir}" --name "${tab_name}"
    else
        echo "Opening new tab '${tab_name}' in current directory"
        zellij action new-tab --layout "${layout_path}" --name "${tab_name}"
    fi
}

# Main function
main() {
    local layout_type="compact"
    local working_dir=""

    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --layout)
                if [[ -n "${2:-}" ]] && [[ "$2" =~ ^(regular|compact)$ ]]; then
                    layout_type="$2"
                    shift 2
                else
                    echo "Error: --layout requires 'regular' or 'compact' as argument"
                    show_help
                    exit 1
                fi
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            -*)
                echo "Error: Unknown option $1"
                show_help
                exit 1
                ;;
            *)
                if [[ -z "${working_dir}" ]]; then
                    working_dir="$1"
                else
                    echo "Error: Multiple directories specified"
                    show_help
                    exit 1
                fi
                shift
                ;;
        esac
    done

    # Get the layout path based on the selected type
    local layout_path
    layout_path=$(get_layout "${layout_type}" "workspace")

    if [[ -z "${layout_path}" ]] || [[ ! -f "${layout_path}" ]]; then
        echo "Error: ${layout_type} workspace layout not found in ${ZJ_LAYOUT_DIR}"
        echo "Expected file: ${layout_type}-workspace-layout.kdl"
        exit 1
    fi

    # If working directory is provided and it's a directory, use it
    if [[ -n "${working_dir}" ]] && [[ -d "${working_dir}" ]]; then
        open_tab_with_layout "${working_dir}" "${layout_path}"
    elif [[ -n "${working_dir}" ]]; then
        echo "Error: Directory not found: ${working_dir}"
        exit 1
    else
        open_tab_with_layout "" "${layout_path}"
    fi
}

main "$@"
