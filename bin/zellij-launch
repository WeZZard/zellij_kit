#!/bin/zsh

# zellij-launch - Zellij session management
# Usage: zellij-launch [--layout regular|compact] [session_name]
# Options:
#   --layout regular|compact  Choose layout (default: regular)
# Examples:
#   zellij-launch                       # Create/attach to 'master' session with regular layout
#   zellij-launch --layout compact      # Create/attach to 'master' session with compact layout
#   zellij-launch mysession             # Create/attach to 'mysession' with regular layout
#   zellij-launch --layout compact mysession  # Create/attach to 'mysession' with compact layout

set -euo pipefail

# Source shared functions
ZJ_SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "${ZJ_SCRIPT_DIR}/zellij-common.zsh"

# Function to show help
show_help() {
    echo "Usage: zellij-launch [--layout regular|compact] [session_name]"
    echo ""
    echo "Options:"
    echo "  --layout regular|compact  Choose layout (default: regular)"
    echo "  --help, -h                Show this help message"
    echo ""
    echo "Examples:"
    echo "  zellij-launch                       # Create/attach to 'master' session with regular layout"
    echo "  zellij-launch --layout compact      # Create/attach to 'master' session with compact layout"
    echo "  zellij-launch mysession             # Create/attach to 'mysession' with regular layout"
    echo "  zellij-launch --layout compact mysession  # Create/attach to 'mysession' with compact layout"
}

# Check for help option early
for arg in "$@"; do
    if [[ "$arg" == "--help" ]] || [[ "$arg" == "-h" ]]; then
        show_help
        exit 0
    fi
done

# Check if already inside a Zellij session to prevent nesting
if [[ -n "${ZELLIJ:-}" ]]; then
    exit 0
fi

# Check if zellij is installed
check_zellij_installed || exit 1

# Function to create new session or attach to existing one
zj_session() {
    local session_name="$1"
    local layout_path="$2"

    if zellij list-sessions --no-formatting 2>/dev/null | grep -q "^${session_name} "; then
        echo "Attaching to existing session: ${session_name}"
        zellij attach "${session_name}"
    else
        echo "Creating new session: ${session_name}"
        if [[ -n "${layout_path}" ]] && [[ -f "${layout_path}" ]]; then
            zellij --new-session-with-layout "${layout_path}" --session "${session_name}"
        else
            echo "Error: Layout file not found: ${layout_path}"
            return 1
        fi
    fi
}

# Main function
main() {
    local layout_type="regular"
    local session_name="master"

    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --layout)
                if [[ -n "${2:-}" ]] && [[ "$2" =~ ^(regular|compact)$ ]]; then
                    layout_type="$2"
                    shift 2
                else
                    echo "Error: --layout requires 'regular' or 'compact' as argument"
                    show_help
                    exit 1
                fi
                ;;
            --help|-h)
                show_help
                exit 0
                ;;
            -*)
                echo "Error: Unknown option $1"
                show_help
                exit 1
                ;;
            *)
                session_name="$1"
                shift
                ;;
        esac
    done

    # Get the layout path based on the selected type
    local layout_path
    layout_path=$(get_layout "${layout_type}" "session")

    if [[ -z "${layout_path}" ]] || [[ ! -f "${layout_path}" ]]; then
        echo "Error: ${layout_type} layout not found in ${ZJ_LAYOUT_DIR}"
        echo "Expected file: ${layout_type}-layout.kdl"
        exit 1
    fi

    # Create or attach to session
    zj_session "${session_name}" "${layout_path}"
}

main "$@"
